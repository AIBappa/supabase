_format_version: '2.1'
_transform: true

###
### Consumers (Secrets pulled from .env)
###
consumers:
  - username: anon
    keyauth_credentials:
      - key: $SUPABASE_ANON_KEY
  - username: service_role
    keyauth_credentials:
      - key: $SUPABASE_SERVICE_KEY
  - username: $DASHBOARD_USERNAME
    basicauth_credentials:
      - username: $DASHBOARD_USERNAME
        password: $DASHBOARD_PASSWORD

###
### ACLs for routing based on user role
###
acls:
  - consumer: anon
    group: anon
  - consumer: service_role
    group: admin
  - consumer: $DASHBOARD_USERNAME
    group: admin

###
### Services and Routes
###
services:
  ## Auth Service (Public - No Auth Required)
  - name: auth-v1
    url: http://auth:9999/
    routes:
      - name: auth-v1-all
        strip_path: true
        paths: [/auth/v1/]
    plugins:
      - name: cors

  ## REST Database API (Protected by JWT in App)
  - name: rest-v1
    url: http://rest:3000/
    routes:
      - name: rest-v1-all
        strip_path: true
        paths: [/rest/v1/]
    plugins:
      - name: cors

  ## Edge Functions (Public)
  - name: functions-v1
    url: http://edge:9000/
    routes:
      - name: functions-v1-all
        strip_path: true
        paths: [/functions/v1/]
    plugins:
      - name: cors

  ## Studio Dashboard (Protected by Basic Auth)
  - name: dashboard
    url: http://studio:3000/
    routes:
      - name: dashboard-all
        strip_path: true
        paths: [/]
    plugins:
      - name: basic-auth
        config:
          hide_credentials: true
